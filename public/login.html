<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    label, input, button {
      font-size: 16px;
      display: block;
      margin-top: 10px;
    }
    p {
      margin-top: 20px;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <h2>Serverga ma'lumot yuborish</h2>

  <label for="textInput">Matn kiriting:</label>
  <input type="text" id="textInput" name="textInput" placeholder="Matn yozing" />
  
  <button id="saveBtn" type="button">Saqlash</button>

  <p id="userCount">Yuklanmoqda...</p>
  <p>Kiritilgan matn: <span id="outputText">-</span></p>

  <script>
    // Unikal ID yaratish va saqlash
    let myID = localStorage.getItem("user_id");
    if (!myID) {
      myID = "user_" + Math.random().toString(36).substring(2, 12);
      localStorage.setItem("user_id", myID);
    }

    // Foydalanuvchini faqat bir marta yuborish
    async function sendUserID() {
      const alreadySent = localStorage.getItem("already_sent");
      if (!alreadySent) {
        try {
          await fetch("/data", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ id: myID })
          });
          localStorage.setItem("already_sent", "true");
        } catch (error) {
          console.error("Foydalanuvchini yuborishda xatolik:", error);
        }
      }
      getUserCount();
    }

    // Kirganlar sonini olish
    async function getUserCount() {
      try {
        const response = await fetch("/data");
        const data = await response.json();
        const text = `Kirgani: ${data.count} foydalanuvchi`;
        document.getElementById("userCount").textContent = text;
      } catch (error) {
        document.getElementById("userCount").textContent =
          "Xatolik: foydalanuvchilar soni olinmadi.";
      }
    }

    // Matn chiqarish
    document.getElementById("saveBtn").addEventListener("click", () => {
      const value = document.getElementById("textInput").value.trim();
      document.getElementById("outputText").textContent = value || "-";
    });

    // DOM tayyor bo‘lsa — ishga tushadi
    window.addEventListener("DOMContentLoaded", sendUserID);
  </script>
</body>
</html>